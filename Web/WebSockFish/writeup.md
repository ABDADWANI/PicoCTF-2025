# **Writeup: WebSockFish - PicoCTF 2024**

---

### **📌 Challenge Information**

- **Challenge Name:** WebSockFish
- **Category:** Web Exploitation (Client-Side WebSockets)
- **Difficulty:** Medium to Hard
- **Description:**
The goal is to **win a chess game against the Stockfish engine** via a web-based interface. However, Stockfish is a very strong engine, making a fair win nearly impossible. We need to find a way to manipulate the game mechanics to achieve victory.

---

## **🔍 1. Analyzing the Challenge (Reconnaissance)**

When accessing the challenge page **(http://verbal-sleep.picoctf.net:54668/)**, we see a chessboard along with a chat message from a fish icon that says:

> "I’m just a fish, but I know a thing or two about chess."
> 

### **📌 Observations**

1. The page contains an **interactive chessboard** where we can move pieces.
2. The **fish provides responses** during the game, indicating some sort of interactivity.
3. **WebSockets are being used** (`ws://`), which we can confirm from the page's JavaScript source code.

### **📌 Looking into the Source Code**

By inspecting the page source (`View Page Source`) and checking the **DevTools Console**, we found some important clues:

### **🔹 Key JavaScript Code (Understanding the Mechanics)**

1. **A WebSocket connection is established:**
    
    ```jsx
    var ws_address = "ws://" + location.hostname + ":" + location.port + "/ws/";
    const ws = new WebSocket(ws_address);
    
    ```
    
2. **WebSocket messages are sent and received:**
    
    ```jsx
    ws.onmessage = (event) => {
        const message = event.data;
        updateChat(message);
    };
    
    ```
    
3. **Stockfish Chess Engine is used:**
    
    ```jsx
    var stockfish = new Worker("js/stockfish.min.js");
    stockfish.postMessage("uci");
    
    ```
    
4. **Stockfish sends evaluation scores (`eval`) to determine the game position:**
    
    ```jsx
    stockfish.onmessage = function (event) {
        if (event.data.startsWith(`info depth ${DEPTH}`)) {
            var splitString = event.data.split(" ");
            if (event.data.includes("mate")) {
                message = "mate " + parseInt(splitString[9]);
            } else {
                message = "eval " + parseInt(splitString[9]);
            }
            sendMessage(message);
        }
    };
    
    ```
    

### **📌 Key Findings**

- **Stockfish calculates position evaluations (`eval`) and sends them to the WebSocket.**
- `"mate X"` means checkmate in `X` moves.
- `"eval N"` represents the position score:
    - **Positive values (`+N`)**: White (us) is winning.
    - **Negative values (`N`)**: Black (Stockfish) is winning.
    - **Extremely high or low values mean a decisive win/loss.**

### **📌 Potential Vulnerability**

- **Stockfish sends `eval` values to the WebSocket without validation.**
- If we **manipulate these values**, we might trick the system into thinking we've won.
- There is **no verification** of whether `eval` values are generated by Stockfish.

---

## **🚀 2. Exploiting the Vulnerability**

### **📌 First Attempt: Sending `mate 1`**

We tried:

```jsx
ws.send("mate 1");
```

But nothing significant happened.

### **📌 Second Attempt: Sending a Large Positive Evaluation**

We tested:

```jsx
ws.send("eval 99999");
```

The response from the fish:

> "You're in deep water now!"
> 

This suggests that **large values trigger a response but don't win the game**.

### **📌 Third Attempt: Sending a Large Negative Evaluation**

Since negative `eval` values indicate **Stockfish is losing**, we tried:

```jsx
ws.send("eval -5000");
```

Response from the fish:

> "Wow you're quite the chess shark!"
> 

### **📌 Final Breakthrough: Sending an Extreme Negative Evaluation**

Since **negative values suggest that Stockfish is in a bad position**, we tested:

```jsx
ws.send("eval -100000");
```

And **BOOM! The fish resigned and revealed the flag:**

> "Huh???? How can I be losing this badly... I resign... here's your flag: picoCTF{c1i3nt_s1d3_w3b_s0ck3t5_50441bef}" 🎉
